- name: setup cache server (apt)
  become: true
  hosts: cacheservers
  handlers:
    - name: Reboot apt-cacher-ng service
      ansible.builtin.systemd:
        name: apt-cacher-ng
        enabled: true
        state: restarted
  tasks:
    - name: Install apt-cacher-ng
      ansible.builtin.apt:
        name: apt-cacher-ng
        state: present
        update_cache: true
        cache_valid_time: 3600
    - name: Setup apt-cacher-ng configuration
      notify: Reboot apt-cacher-ng service
      ansible.builtin.template:
        src: templates/cacheservers/apt-cache-ng.conf.j2
        dest: /etc/apt-cacher-ng/acng.conf
        mode: '0644'

- name: Configure proxy on clients
  become: true
  hosts: all
  tasks:
    - name: Add apt configuration file with http proxy
      ansible.builtin.copy:
        content: 'Acquire::http::Proxy "http://{{ apt_cache_server }}:{{ apt_cache_port }}";'
        dest: '/etc/apt/apt.conf.d/00aptproxy'
        mode: '0644'
